<!DOCTYPE html>
<html>

<head>
  <style>
    .sidebar {
      width: 200px;
      /* Ancho de la columna de usuarios */
      height: 100%;
      position: fixed;
      /* Fijar la posición */
      top: 78px;
      /* Asegurar que la barra lateral comience debajo de la cabecera */
      left: 0;
      background-color: #f4f4f4;
      /* Color de fondo */
      overflow-y: auto;
      /* Permitir desplazamiento vertical si la lista es muy larga */
      padding: 20px;
      z-index: 98;
      /* Asegurarse de que la barra lateral esté detrás de la cabecera */
    }

    /* Estilos para los elementos de la lista de usuarios */
    .sidebar h2 {
      margin-bottom: 10px;
    }

    .sidebar ul {
      list-style-type: none;
      /* Quitar viñetas de la lista */
      padding: 0;
      margin: 0;
    }

    .sidebar li {
      padding: 5px;
      cursor: pointer;
      /* Cambiar cursor al pasar sobre los usuarios */
    }

    .sidebar li:hover {
      background-color: #ddd;
      /* Cambiar color de fondo al pasar sobre los usuarios */
    }

    /* Estilos para el área principal */
    #main {
      margin-left: 200px;
      /* Dejar espacio a la izquierda para la columna de usuarios */
      padding: 20px;
    }

    body {
      font-family: Arial, sans-serif;
      text-align: center;
      background-color: #ffffff;
      margin: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
    }




    h1,
    h2 {
      color: #2979ff;
    }

    #response {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border: 1px solid #ccc;
      border-radius: 5px;
    }

    button {
      padding: 10px 20px;
      margin: 5px;
      border: none;
      border-radius: 20px;
      cursor: pointer;
      font-weight: bold;
    }


    #resetButton {
      background-color: rgb(255, 255, 255);
      /* Cambiar el color a rojo */
      color: #2cda00;
      align-self: flex-end;
      /* Cambiar a flex-end para alinear a la derecha */
      margin-top: 20px;
    }




    .floating-window {
      position: absolute;
      width: 300px;
      background-color: #fff;
      border: 1px solid #ccc;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .window-header {
      background-color: #00c94d;
      color: #fff;
      padding: 10px;
      cursor: move;
    }



    #contestarButton {
      background-color: #4caf50;
      color: #fff;
    }





    body {
      margin: 0;
      padding: 0;
      /* Agrega otros estilos para el contenido del body si es necesario */
    }

    #header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 20px;
      /* Ajustar el padding horizontal para evitar solapamientos */
      background-color: #00c94d;
      /* Color con opacidad del 50% */
      width: 100%;
      /* Hacer que la cabecera ocupe todo el ancho */
      position: fixed;
      /* Fijar la cabecera en la parte superior */
      top: 0;
      /* Colocarla en la parte superior */
      z-index: 99;
      /* Asegurarse de que esté sobre otros elementos */
    }


    #header img {
      height: 60px;
      /* Tamaño del logo */
    }

    /* Ajustar el espacio debajo de la cabecera */
    body {
      margin-top: 60px;
      /* Asegurar que el contenido comience debajo de la cabecera */
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      height: 100vh;
    }

    .whatsapp-box.cambio-1 {
      font-weight: bold;
    }

    #chat-box {
      width: 100%;
      min-height: 300px;
      /* Altura mínima inicial */
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      padding: 20px;
      overflow-y: auto;
      position: fixed;
      bottom: 90px;
      left: 230px;
      right: 0;
      margin: auto;
    }

    /* Estilos para los mensajes */
    #messages1 {
      width: 80%;
      min-height: 700px;
      /* Altura mínima inicial para los mensajes */
      max-height: 700px;
      overflow-y: auto;
      direction: ltr;
      padding: 10px;
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      margin: auto;
      margin-left: 20px;
    }

    #messages1 div {
      text-align: left;
      margin-bottom: 20px;
      font-size: 16px;
      word-wrap: break-word;
    }





    /* Estilos para el área de respuesta */
    #response-area {
      display: flex;
      align-items: center;
      width: 86%;
      position: fixed;
      /* Fijar el área de respuesta */
      bottom: 0;
      /* Posicionar en la parte inferior */
      left: 120;
      /* Alinear a la izquierda */
      right: 0;
      /* Alinear a la derecha */
      margin: auto;
      /* Centrar horizontalmente */
      z-index: 1;
      /* Colocar el área de respuesta encima del chat-box */
    }

    /* Estilos para el textarea de respuesta */
    #response {
      width: calc(100% - 90px);
      margin-right: 10px;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
      resize: none;
    }

    /* Estilos para los botones de respuesta */
    #response-buttons {
      display: flex;
      gap: 10px;
    }

    /* Estilos específicos para los botones */
    #enviarRespuesta1 {
      background-color: #02d630;
      color: #fff;
    }

    #contestarButton {
      background-color: #4caf50;
      color: #fff;
    }

    /* Estilos para los elementos dentro de la cabecera */
    .cabecera-elementos {
      display: flex;
      /* Mostrar los elementos en línea */
      gap: 10px;
      /* Espacio entre los elementos */
      color: #fff;
      /* Cambiar color del texto para visualización */
      justify-content: flex-start;
      /* Alinear elementos a la izquierda */
    }


    #colaespera1,
    #resultado,
    #BuscarOrden {
      padding: 10px;
      border-radius: 5px;
      background-color: #ffffff;
      /* Cambia el color de fondo según tu preferencia */
      color: #01be3a;
      margin-bottom: 10px;
      /* Espacio entre divs */
    }

    .whatsapp-box.cambio-1 {
      background-color: #24baff;
      /* Verde claro al estilo de WhatsApp */
      padding: 5px 10px;
      /* Espaciado interno */
      margin-bottom: 1px;
      /* Espaciado inferior */
      cursor: pointer;
      /* Cambiar cursor al pasar por encima */
      border-radius: 5px;

    }

    /* Estilo para archivos con Cambio = 0 (mismo estilo que antes) */
    .whatsapp-box.cambio-0 {
      background-color: #df0909;
      /* Verde claro al estilo de WhatsApp */
      padding: 5px 10px;
      margin-bottom: 1px;
      cursor: pointer;
      border-radius: 5px;
    }

    .whatsapp-box {
      background-color: #1ff714;
      /* Verde claro al estilo de WhatsApp */
      padding: 5px 10px;
      /* Espaciado interno */
      margin-bottom: 1px;
      /* Espaciado inferior */
      cursor: pointer;
      /* Cambiar cursor al pasar por encima */
      border-radius: 5px;
      /* Bordes redondeados */
    }
  </style>
</head>

<title>John Store</title>
<!-- Cabecera -->
<div id="header">
  <div>
    <img src="logo.png" alt="Logo"> <!-- Colocar el logo aquí -->
  </div>
  <div class="cabecera-elementos">
    <div id="resultado">Resultado</div>
    <div id="BuscarOrden">Buscar Orden</div>

  </div>
  <div>
    <button id="resetButton">Contacto Creativo</button> 
  </div>
  
</div>


<div class="sidebar">
  <h2>Usuarios</h2>
  <div id="historial"></div>
</div>


<!-- Contenedor principal -->
<div id="chat-box">

  <div id="messages1">
    <!-- Aquí se mostrarán los mensajes recibidos -->
    Mensajes anteriores...
  </div>
</div>

<!-- Área de respuesta -->
<div id="response-area">
  <textarea id="response" rows="4" placeholder="Escribe tu mensaje..."></textarea>
  <div id="response-buttons">
    <button id="enviarRespuesta1">Enviar</button>
    <!-- <button id="contestarButton">Enviar</button> -->
  </div>
</div>





<script>
  document.getElementById('btnActualizar').addEventListener('click', () => {
    fetch('/actualizararray1', {
      method: 'POST'
    })
      .then(response => response.text())
      .then(data => {
        console.log(data); // Muestra la respuesta del servidor en la consola
        // Puedes hacer algo más con la respuesta del servidor aquí
      })
      .catch(error => {
        console.error('Error:', error);
      });
  });
</script>


<script>


  // /////////////////////////////////////////////////////////////////////
  //////////////// MUESTRA EL HISTORIAL
  ////////////////////////////////////////////

  const historialDiv = document.getElementById('historial');

async function cargarHistorial() {
  const response = await fetch('/historial');
  const files = await response.json();

  files.forEach(async fileName => {
    const fileContentResponse = await fetch(`/historial/${fileName}`);
    const fileContent = await fileContentResponse.json();
    const lastBody = fileContent[fileContent.length - 1].body;

    // Obtener las dos últimas palabras del body, o reemplazarlas por "imagen" si la última palabra es una URL
    let lastTwoWords;
    const bodyWords = lastBody.split(' ');
    if (/^(https?|ftp):\/\/[^\s/$.?#].[^\s]*$/.test(bodyWords[bodyWords.length - 1])) {
      lastTwoWords = 'imagen';
    } else {
      lastTwoWords = bodyWords.slice(-2).join(' ');
    }

    const fileNameWithoutExtension = fileName.replace('.json', '');
    const link = document.createElement('div');
    link.classList.add('whatsapp-box');

    const circleSpan = document.createElement('span');
    circleSpan.textContent = '●';
    circleSpan.style.color = fileContent[fileContent.length - 1].Cambio === 1 ? 'red' : 'black';

    link.appendChild(circleSpan);
    link.innerHTML += `${fileNameWithoutExtension}: <br>${lastTwoWords}`;

    link.addEventListener('click', async () => {
      const fileName = fileNameWithoutExtension;

      const fileContentResponse = await fetch(`/historial/${fileName}.json`);
      let fileContent = await fileContentResponse.json();

      // Actualizar el valor de Cambio en el archivo JSON original
      fileContent = fileContent.map(item => {
        item.Cambio = 0;
        return item;
      });

      const updateResponse = await fetch(`/historial/${fileName}.json`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(fileContent)
      });

      if (updateResponse.ok) {
        console.log('Archivo actualizado: Cambio = 0');
        MensajeIndex.push(...fileContent);
        console.log('MensajeIndex actualizado:', MensajeIndex);
      } else {
        console.error('Error al actualizar el archivo');
      }
    });

    historialDiv.appendChild(link);
    historialDiv.appendChild(document.createElement('br'));
  });
}

cargarHistorial();




</script>







<script>



  // ESTE FRAGMENTO COLCOA EL NOMBRE EL USUARIO EN PANTALLA /////////

  function obtenerUsuario1() {
    // Realiza una solicitud GET al servidor
    fetch('/Usuarioget1')
      .then(response => response.text())
      .then(data => {
        // Verifica si data no está vacío antes de mostrarlo
        if (data.trim() !== '') {
          const mensaje = `Usuario: ${data}`;
          document.getElementById('resultado').innerHTML = mensaje;
        } else {
          // Si data está vacío, no muestra nada en el cliente
          document.getElementById('resultado').innerHTML = '';
        }
      })
      .catch(error => {
        console.error('Error:', error);
      });
  }

  // Llama a la función obtenerUsuario1() cada 2 segundos
  setInterval(obtenerUsuario1, 1000);




  // ESTE NUMERO USUARIO EN PANTALLA /////////

  function Buscarord() {
    // Realiza una solicitud GET al servidor
    fetch('/BuscaOrden')
      .then(response => response.text())
      .then(data => {
        // Verifica si data no está vacío antes de mostrarlo
        if (data.trim() !== '') {
          const mensaje = `Número: ${data}`;
          document.getElementById('BuscarOrden').innerHTML = mensaje;
        } else {
          // Si data está vacío, no muestra nada en el cliente
          document.getElementById('BuscarOrden').innerHTML = '';
        }
      })
      .catch(error => {
        console.error('Error:', error);
      });
  }

  // Llama a la función obtenerUsuario1() cada 2 segundos
  setInterval(Buscarord, 2000);








  // //////////////////////////

  // esto reinicia el array 
  document.getElementById('resetButton').addEventListener('click', function () {
    // Realizar una solicitud al servidor para reiniciar el array
    fetch('/reset-array', { method: 'POST' })
      .then(response => response.json())
      .then(data => {
        // alert(data.message); // Mostrar mensaje del servidor
      })
      .catch(error => {
        console.error('Error:', error);
      });
  });






  //     document.getElementById('contestarButton').addEventListener('click', function() {
  //     // Realiza la llamada fetch o cualquier otra acción necesaria

  //     // Cambiar el color del botón a rojo
  //     this.style.backgroundColor = 'red';

  //     fetch('/actualizar1', { method: 'POST' })
  //         .then(response => response.json())
  //         .then(data => {
  //             // Puedes realizar acciones adicionales después de la actualización

  //             // Cambiar el color del botón a verde después de 2 segundos (2000 milisegundos)
  //             setTimeout(() => {
  //                 this.style.backgroundColor = 'green';
  //             }, 2000);
  //         })
  //         .catch(error => {
  //             console.error('Error:', error);
  //         });
  // });
  // 




  // funcion para recibir los mensajes 
  // funcion para recibir los mensajes 
  async function cargarMensajes() {
    try {
      const response = await fetch('/obtenerMensajes1');
      const data = await response.json();

      const messagesDiv = document.getElementById('messages1');

      messagesDiv.innerHTML = '';

      data.filter(message => message.trim() !== '').forEach(message => {
        if (isURL(message)) {
          if (message.endsWith('.ogg')) {
            const audioElement = document.createElement('audio');
            audioElement.src = message;
            audioElement.controls = true; // Agregar controles de reproducción
            audioElement.style.marginBottom = '20px'; // Espacio entre elementos
            messagesDiv.appendChild(audioElement);
          } else {
            const imageElement = document.createElement('img');
            imageElement.src = message;
            imageElement.alt = 'Imagen cargada dinámicamente';
            imageElement.style.width = '200px'; // Establece el ancho de la imagen
            imageElement.style.height = '200px'; // Establece la altura de la imagen
            imageElement.style.objectFit = 'cover'; // Ajusta la imagen para que llene el contenedor manteniendo la relación de aspecto
            imageElement.style.cursor = 'pointer'; // Cambia el cursor al pasar sobre la imagen
            imageElement.addEventListener('click', function () {
              const newWindow = window.open(message, '_blank');
              if (newWindow) {
                newWindow.focus();
              } else {
                alert('La ventana emergente fue bloqueada. Por favor, permite las ventanas emergentes para ver la imagen.');
              }
            });

            messagesDiv.appendChild(imageElement);
          }
        } else {
          const messageElement = document.createElement('div');
          messageElement.textContent = message;

          // Establecer estilos...
          messageElement.style.padding = '10px';
          messageElement.style.borderRadius = '8px';
          messageElement.style.marginBottom = '20px';
          messageElement.style.fontSize = '16px';
          messageElement.style.wordWrap = 'break-word';
          messageElement.style.position = 'relative'; // Para usar posición absoluta en la sombra

          // Colocar mensajes que empiezan con "Asesor" a la izquierda
          if (message.startsWith('Asesor:')) {
            messageElement.style.textAlign = 'left';
            messageElement.style.backgroundColor = '#f0f0f0';
          } else {
            messageElement.style.textAlign = 'right';
            messageElement.style.backgroundColor = '#e2f7cb'; // Color de fondo para mensajes no "Asesor"
          }

          // Añadir sombra
          const shadow = document.createElement('div');
          shadow.className = 'message-shadow';
          shadow.style.position = 'absolute';
          shadow.style.top = '0';
          shadow.style.left = '0';
          shadow.style.width = `${messageElement.scrollWidth}px`; // Ancho igual al ancho del texto
          shadow.style.height = `${messageElement.scrollHeight}px`; // Alto igual al alto del texto
          shadow.style.borderRadius = '8px';
          shadow.style.boxShadow = '0 0 10px rgba(0, 0, 0, 0.1)'; // Sombras más cortas
          messageElement.appendChild(shadow);


          messagesDiv.appendChild(messageElement);
        }
      });
    } catch (error) {
      console.error('Error al cargar mensajes:', error);
    }
  }

  function isURL(str) {
    // Función para verificar si una cadena es una URL
    const pattern = /^(http|https):\/\/[^ "]+$/;
    return pattern.test(str);
  }







  // funcion paar enviar mensajes
  async function enviarRespuesta() {
    const responseText = document.getElementById('response').value;
    const response = await fetch('/responderMensaje1', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ response: responseText })
    });

    document.getElementById('response').value = '';
    cargarMensajes();
  }

  function enviarAutomaticamenteDespuesDeUnSegundo() {
    setTimeout(() => {
      fetch('/actualizar1', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
          // Manejar la respuesta de la solicitud aquí si es necesario
          console.log('Solicitud automática completada:', data);
        })
        .catch(error => {
          console.error('Error al realizar la solicitud automática:', error);
        });
    }, 1000); // Espera 1 segundo (1000 milisegundos) antes de enviar la solicitud
  }

  function cambiarColorBoton(color) {
    document.getElementById('enviarRespuesta1').style.backgroundColor = color;
  }

  cargarMensajes();

  document.getElementById('enviarRespuesta1').addEventListener('click', () => {
    cambiarColorBoton('red'); // Cambiar color a rojo al hacer clic
    enviarRespuesta();
    enviarAutomaticamenteDespuesDeUnSegundo();

    setTimeout(() => {
      cambiarColorBoton('green'); // Cambiar color a verde después de 2 segundos
    }, 2000);
  });





  // Actualizar automáticamente cada 5 segundos (5000 milisegundos)
  setInterval(cargarMensajes, 3000);



</script>
</body>

</html>